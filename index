<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Piattaforma Accrediti — Lactalis / All4U (v3 — glassmorphism)</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

<style>
  /* Palette 2EMME / Ottanio glassmorphism */
  :root{
    --ottanio: #004D54;
    --magenta: #DB4F61;
    --verde: #54C4A6;
    --carta: #BFEBFF;
    --glass-bg: rgba(255,255,255,0.06);
    --card-bg: rgba(255,255,255,0.06);
    --accent: var(--ottanio);
  }
  html,body{height:100%;background:
    linear-gradient(180deg, rgba(11,34,36,1) 0%, rgba(4,77,84,1) 50% , rgba(11,34,36,1) 100% ); color:#fff; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
  .app-shell{min-height:100vh; padding:28px; display:flex; flex-direction:column; gap:18px;}
  .glass {
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border: 1px solid rgba(255,255,255,0.06);
    box-shadow: 0 6px 20px rgba(0,0,0,0.45);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-radius: 12px;
    padding: 14px;
  }
  h2 small {color: rgba(255,255,255,0.7); font-weight:400}
  .small-muted {color: rgba(255,255,255,0.7); font-size:0.9rem}
  .btn-ottanio {background:var(--ottanio); color: #fff; border:0}
  .btn-ottanio-outline {color:var(--ottanio); border:1px solid rgba(255,255,255,0.12); background:transparent}
  .table-fixed {max-height: 56vh; overflow:auto; display:block;}
  table thead {position: sticky; top: 0; background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); z-index:5}
  .tag {display:inline-block;padding:3px 6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);margin:2px;font-size:0.78rem;background:rgba(255,255,255,0.02)}
  .code-pill{background:transparent;padding:4px;border-radius:6px;border:1px dashed rgba(255,255,255,0.04);display:inline-flex;gap:8px;align-items:center}
  .label-preview{display:flex;flex-direction:column;align-items:center;justify-content:center;height:36mm;width:70mm;border-radius:6px;border:0;background:transparent;color:var(--ottanio)}
  .label-code{font-weight:800;font-size:20px; color:var(--ottanio)}
  .label-name{font-size:10px;color:rgba(0,0,0,0.75)}
  .accepted {background: linear-gradient(90deg, rgba(84,196,166,0.08), rgba(84,196,166,0.03)) !important}
  .controls .btn{margin-right:6px}
  .muted {color: rgba(255,255,255,0.6)}
  /* layout print for A4 3 columns */
  @media print {
    @page { size: A4; margin: 2.5mm 0 2.5mm 0; }
    body{background:transparent;color:#000}
  }
</style>
</head>
<body>
<div class="app-shell container">
  <div class="glass">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2>Accrediti — Lactalis / All4U <small>v3 — glass</small></h2>
        <div class="small-muted">Importa CSV / XLSX — colonne: Name, cognome, nome, email, hotel, notti, codeCoat, codeLuggage, assigned_pallet, dinner, Spunta, allergies</div>
      </div>
      <div class="text-end">
        <div class="small-muted">Palette: Ottanio / Magenta / Verde</div>
      </div>
    </div>

    <hr class="my-2">

    <div class="row mb-2 controls">
      <div class="col-md-4 mb-2">
        <input id="fileInput" type="file" class="form-control form-control-sm" accept=".csv,.xlsx,.xls,.ods,.json">
      </div>
      <div class="col-md-4 mb-2">
        <input id="searchInput" type="search" class="form-control form-control-sm" placeholder="Cerca per cognome, nome, codice...">
      </div>
      <div class="col-md-4 text-end">
        <button id="btnGenerateMissing" class="btn btn-ottanio btn-sm">Genera codici mancanti</button>
        <button id="btnGenerateCoatLabels" class="btn btn-success btn-sm">Etichette Cappotto (A4)</button>
        <button id="btnGenerateLuggLabels" class="btn btn-outline-success btn-sm">Etichette Bagaglio (A4)</button>
        <button id="btnPrintM110" class="btn btn-ottanio-outline btn-sm">Stampa M110 (roll)</button>
      </div>
    </div>

    <div class="mb-2 d-flex gap-2">
      <button id="btnShowAdd" class="btn btn-outline-light btn-sm">Aggiungi ospite</button>
      <button id="btnExportCSV" class="btn btn-outline-light btn-sm">Esporta CSV</button>
      <button id="btnExportJSON" class="btn btn-outline-light btn-sm">Esporta JSON</button>
      <button id="btnAccreditaSel" class="btn btn-ottanio btn-sm">Accredita selezionati</button>
      <button id="btnClear" class="btn btn-danger btn-sm">Reset locale</button>
    </div>

    <div class="row g-2 mb-3">
      <div class="col-md-3"><div class="glass p-2"><div class="muted">Totale</div><h4 id="totalCount">0</h4></div></div>
      <div class="col-md-3"><div class="glass p-2"><div class="muted">Accreditati</div><h4 id="acceptedCount">0</h4></div></div>
      <div class="col-md-3"><div class="glass p-2"><div class="muted">In attesa</div><h4 id="pendingCount">0</h4></div></div>
      <div class="col-md-3"><div class="glass p-2"><div class="muted">Tempo medio</div><h4 id="avgTime">--</h4></div></div>
    </div>

    <div id="tableWrap" class="table-responsive table-fixed glass border p-0">
      <table id="guestsTable" class="table table-sm table-borderless m-0 text-white align-middle">
        <thead>
          <tr>
            <th style="width:36px"><input id="selectAll" type="checkbox"></th>
            <th>Cognome</th>
            <th>Nome</th>
            <th>Codice</th>
            <th>Coat</th>
            <th>Lugg</th>
            <th>Allergie</th>
            <th>Cena</th>
            <th>Accredita</th>
            <th>Stato</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div id="detailArea" class="mt-3"></div>
  </div>
</div>

<!-- Modal add/edit -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form id="editForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Dettagli Ospite</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editIndex">
        <div class="row">
          <div class="col-md-6">
            <h6>Info primarie</h6>
            <div class="mb-2"><label class="form-label">Codice Cliente (Name)</label><input id="mCode" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Cognome</label><input id="mCognome" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Nome</label><input id="mNome" class="form-control"></div>

            <div class="mb-2"><label class="form-label">Codici Cappotto</label>
              <div id="mCoatsList" class="codes-list mb-2"></div>
              <div class="input-group">
                <input id="mCoatNew" class="form-control" placeholder="Aggiungi codice coat (es: C-ROSSI-001)">
                <button id="addCoatBtn" class="btn btn-outline-secondary" type="button">Aggiungi</button>
              </div>
            </div>

            <div class="mb-2"><label class="form-label">Codici Bagaglio</label>
              <div id="mLuggsList" class="codes-list mb-2"></div>
              <div class="input-group">
                <input id="mLuggNew" class="form-control" placeholder="Aggiungi codice luggage (es: L-ROSSI-001)">
                <button id="addLuggBtn" class="btn btn-outline-secondary" type="button">Aggiungi</button>
              </div>
            </div>

            <div class="form-check mt-2"><input id="mCena" type="checkbox" class="form-check-input"><label class="form-check-label">Partecipa alla cena</label></div>
          </div>

          <div class="col-md-6">
            <h6>Info secondarie</h6>
            <div class="mb-2"><label class="form-label">Email</label><input id="mEmail" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Hotel</label><input id="mHotel" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Notti</label><input id="mNotti" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Assigned pallet</label><input id="mPallet" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Spunta (obbligatoria)</label><input id="mSpunta" class="form-control" placeholder="es: Nessuna / Si / Specifica"></div>
            <div class="mb-2"><label class="form-label">Allergie</label><input id="mAllergie" class="form-control" placeholder="Lascia 'Nessuna' se non ci sono"></div>

            <div class="mt-3">
              <button id="btnToggleExtra" type="button" class="btn btn-sm btn-outline-light">Mostra dettagli extra</button>
            </div>

            <div id="extraPanel" style="display:none" class="mt-3 small-muted">
              <!-- dettagli extra -->
              <div><strong>Codici aggiuntivi:</strong> <span id="extraCodes"></span></div>
              <div class="mt-2"><strong>Note:</strong> <span id="extraNote"></span></div>
            </div>

            <div class="small-muted mt-3">Timestamp accreditamento: <span id="mTimestamp">-</span></div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" id="deleteRow" class="btn btn-outline-danger">Elimina</button>
        <button type="submit" class="btn btn-primary">Salva</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
      </div>
    </form>
  </div>
</div>

<!-- libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* v3: glass + generate missing codes + print M110 + require spunta before accredito */
let guests = [];
const STORAGE_KEY = 'accrediti_guests_v3';

// helpers
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(guests)); renderTable(); updateMetrics(); }
function loadState(){ const s=localStorage.getItem(STORAGE_KEY); guests = s ? JSON.parse(s) : []; renderTable(); updateMetrics(); }

function splitCodesRaw(str){
  if(!str && str !== 0) return [];
  str = String(str).trim();
  if(!str) return [];
  return Array.from(new Set(str.split(/[;,|\n\s]+/).map(t=>t.trim()).filter(Boolean)));
}

function normalizeRowForImport(r){
  const get = (keys) => { for (const k of keys) if (r[k] !== undefined && r[k] !== null) return String(r[k]).trim(); return ''; };
  const obj = {};
  obj.code_client = get(['Name','name','name_client','code_client']) || get(['name']);
  obj.cognome = get(['cognome','Cognome','Surname','surname']) || '';
  obj.nome = get(['nome','Nome','givenName']) || '';
  obj.email = get(['email','Email','EMAIL']) || '';
  obj.hotel = get(['hotel','Hotel']) || '';
  obj.notti = get(['notti','Notti','nights']) || '';
  const coatRaw = get(['codeCoat','CodeCoat','code_coat','codice_coat','coat','Coat']);
  const luggRaw = get(['codeLuggage','codeLugg','code_lugg','CodeLuggage','luggage','Lugg']);
  obj.codice_coat = splitCodesRaw(coatRaw);
  obj.codice_lugg = splitCodesRaw(luggRaw);
  obj.assigned_pallet = get(['assigned_pallet','assigned pallet','pallet']) || '';
  const dinnerRaw = get(['dinner','Dinner','cena','Cena']);
  obj.cena = (dinnerRaw.toString().toLowerCase().startsWith('s') || dinnerRaw.toString().toLowerCase().startsWith('y')) ? true : false;
  obj.spunta = get(['Spunta','spunta']) || '';
  obj.allergies = get(['allergies','Allergies','ALLERGIE','allergie']) || '';
  obj.note = get(['note','Note']) || '';
  obj.accreditato = false;
  obj.accredit_timestamp = '';
  obj.createdAt = new Date().toISOString();
  return obj;
}

function findGuestByCodeClient(code){ if(!code) return -1; return guests.findIndex(g => String(g.code_client).toLowerCase() === String(code).toLowerCase()); }

function mergeGuest(existingIdx, incoming){
  const g = guests[existingIdx];
  g.codice_coat = Array.from(new Set([...(g.codice_coat||[]), ...(incoming.codice_coat||[])]));
  g.codice_lugg = Array.from(new Set([...(g.codice_lugg||[]), ...(incoming.codice_lugg||[])]));
  ['email','hotel','notti','assigned_pallet','spunta','allergies','note'].forEach(k=>{ if (incoming[k]) g[k] = incoming[k]; });
  if (!g.cognome && incoming.cognome) g.cognome = incoming.cognome;
  if (!g.nome && incoming.nome) g.nome = incoming.nome;
  if (incoming.cena) g.cena = true;
  saveState();
}

function addNewGuest(obj){
  guests.push({
    code_client: obj.code_client || '',
    cognome: obj.cognome || '',
    nome: obj.nome || '',
    email: obj.email || '',
    hotel: obj.hotel || '',
    notti: obj.notti || '',
    codice_coat: obj.codice_coat || [],
    codice_lugg: obj.codice_lugg || [],
    assigned_pallet: obj.assigned_pallet || '',
    cena: !!obj.cena,
    spunta: obj.spunta || '',
    allergies: obj.allergies || '',
    note: obj.note || '',
    accreditato: false,
    accredit_timestamp: '',
    createdAt: obj.createdAt || new Date().toISOString()
  });
  saveState();
}

function importRows(rows){
  const imported = rows.map(r=>normalizeRowForImport(r));
  let countNew = 0, countMerged = 0;
  imported.forEach(incoming=>{
    if (!incoming.code_client) incoming.code_client = (incoming.cognome + (incoming.nome?('-'+incoming.nome):'')).trim();
    const idx = findGuestByCodeClient(incoming.code_client);
    if (idx >= 0){ mergeGuest(idx, incoming); countMerged++; } else { addNewGuest(incoming); countNew++; }
  });
  alert(`Import completato: ${countNew} nuovi, ${countMerged} aggiornati (merge codici).`);
}

// generate missing codes
function generateMissingCodes(){
  let coatCounter=1, luggCounter=1, created=0;
  const pad = (n)=>String(n).padStart(3,'0');
  // find highest counters existing
  guests.forEach(g=>{
    (g.codice_coat||[]).forEach(c=>{
      const m = c.match(/(\d{3})$/); if(m){ const v=parseInt(m[1],10); if(v>=coatCounter) coatCounter=v+1; }
    });
    (g.codice_lugg||[]).forEach(c=>{
      const m = c.match(/(\d{3})$/); if(m){ const v=parseInt(m[1],10); if(v>=luggCounter) luggCounter=v+1; }
    });
  });
  guests.forEach((g,idx)=>{
    if(!g.codice_coat || !g.codice_coat.length){
      const base = (g.cognome||'X').toUpperCase().replace(/\s+/g,'').slice(0,10);
      const code = `C-${base}-${pad(coatCounter++)}`;
      g.codice_coat = g.codice_coat || []; g.codice_coat.push(code); created++;
    }
    if(!g.codice_lugg || !g.codice_lugg.length){
      const base = (g.cognome||'X').toUpperCase().replace(/\s+/g,'').slice(0,10);
      const code = `L-${base}-${pad(luggCounter++)}`;
      g.codice_lugg = g.codice_lugg || []; g.codice_lugg.push(code); created++;
    }
  });
  saveState();
  alert('Generati ' + created + ' codici mancanti.');
}

// render table
function renderTable(filter=''){
  const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
  const f = filter.trim().toLowerCase();
  const sorted = [...guests].sort((a,b)=>{ const A=(a.cognome||'').toLowerCase(), B=(b.cognome||'').toLowerCase(); if(A<B) return -1; if(A>B) return 1; return (a.nome||'').toLowerCase().localeCompare((b.nome||'').toLowerCase()); });
  sorted.forEach((g) => {
    if (f) { const combined = ((g.cognome||'')+' '+(g.nome||'')+' '+(g.code_client||'')+' '+(g.codice_coat||[]).join(' ')+' '+(g.codice_lugg||[]).join(' ')).toLowerCase(); if (!combined.includes(f)) return; }
    const tr = document.createElement('tr');
    if (g.accreditato) tr.classList.add('accepted');
    tr.innerHTML = `
      <td><input class="row-select" type="checkbox" data-index="${guests.findIndex(x=>x.code_client===g.code_client)}"></td>
      <td>${escapeHtml(g.cognome||'')}</td>
      <td>${escapeHtml(g.nome||'')}</td>
      <td>${escapeHtml(g.code_client||'')}</td>
      <td>${(g.codice_coat||[]).slice(0,3).map(c=>'<span class="tag">'+escapeHtml(c)+'</span>').join(' ')}</td>
      <td>${(g.codice_lugg||[]).slice(0,3).map(c=>'<span class="tag">'+escapeHtml(c)+'</span>').join(' ')}</td>
      <td>${escapeHtml(g.allergies||'')}</td>
      <td>${g.cena? '✔':''}</td>
      <td><button class="btn btn-sm btn-success btn-accredita" data-index="${guests.findIndex(x=>x.code_client===g.code_client)}">Accredita</button></td>
      <td class="small-muted">${g.accreditato?('Accreditato @ '+g.accredit_timestamp):'Pending'}</td>
    `;
    // row click opens modal (except clicks on buttons/inputs)
    tr.addEventListener('click', (ev)=>{
      if (ev.target.tagName.toLowerCase() === 'input' || ev.target.tagName.toLowerCase() === 'button' || ev.target.closest('.btn-accredita')) return;
      openEditModal(guests.findIndex(x=>x.code_client===g.code_client));
    });
    tbody.appendChild(tr);
  });
  // add accredita handlers after DOM built
  document.querySelectorAll('.btn-accredita').forEach(b=> b.addEventListener('click', (ev)=>{ ev.stopPropagation(); const idx=parseInt(b.dataset.index,10); accreditaIndex(idx); }));
}

// escape helper
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }

function updateMetrics(){
  const total = guests.length; const accepted = guests.filter(g => g.accreditato).length; const pending = total - accepted;
  document.getElementById('totalCount').innerText = total;
  document.getElementById('acceptedCount').innerText = accepted;
  document.getElementById('pendingCount').innerText = pending;
  const durations = guests.filter(g=>g.accreditato && g.accredit_timestamp && g.createdAt).map(g=>{ const d1=new Date(g.createdAt); const d2=new Date(g.accredit_timestamp); return (d2-d1)/1000; }).filter(n=>!isNaN(n) && n>0);
  let avgText = '--';
  if (durations.length){ const avgSec = durations.reduce((a,b)=>a+b,0)/durations.length; const h=Math.floor(avgSec/3600), m=Math.floor((avgSec%3600)/60), s=Math.round(avgSec%60); avgText = `${h}h ${m}m ${s}s`; }
  document.getElementById('avgTime').innerText = avgText;
  document.title = `Accrediti — ${accepted}/${total}`;
}

// accreditation: now checks spunta
function accreditaIndex(i){
  const g = guests[i];
  // require "spunta" (user requested: spunta per allergie - se non impostato non si può accreditare)
  if (!g.spunta || String(g.spunta).trim() === ''){
    alert('Impossibile accreditare: la spunta (campo obbligatorio) non è impostata per questo ospite. Apri i dettagli e inserisci "Nessuna" o la specifica.');
    return;
  }
  // ok: accredito immediato
  const now = new Date().toISOString();
  guests[i].accreditato = true; guests[i].accredit_timestamp = now; saveState();
  // visual feedback
  renderTable(document.getElementById('searchInput').value);
}

// Bulk accredita with check
function bulkAccredit(){
  const selected = Array.from(document.querySelectorAll('.row-select')).filter(cb=>cb.checked).map(cb=>parseInt(cb.dataset.index,10));
  if (!selected.length){ alert('Seleziona almeno una riga.'); return; }
  // check spunta for each
  const missing = selected.filter(i=> !guests[i].spunta || String(guests[i].spunta).trim()==='');
  if (missing.length){
    alert('Alcuni selezionati non hanno la spunta obbligatoria. Apri i dettagli e imposta la spunta (o togli la selezione).'); return;
  }
  const now = new Date().toISOString();
  selected.forEach(i=>{ guests[i].accreditato = true; guests[i].accredit_timestamp = now; });
  saveState();
}

// open modal
function openEditModal(i){
  const modalEl = document.getElementById('editModal'); const modal = new bootstrap.Modal(modalEl);
  const g = guests[i];
  document.getElementById('editIndex').value = i;
  document.getElementById('mCode').value = g.code_client || '';
  document.getElementById('mCognome').value = g.cognome || '';
  document.getElementById('mNome').value = g.nome || '';
  document.getElementById('mEmail').value = g.email || '';
  document.getElementById('mHotel').value = g.hotel || '';
  document.getElementById('mNotti').value = g.notti || '';
  document.getElementById('mPallet').value = g.assigned_pallet || '';
  document.getElementById('mSpunta').value = g.spunta || '';
  document.getElementById('mAllergie').value = g.allergies || '';
  document.getElementById('mNote').value = g.note || '';
  document.getElementById('mCena').checked = !!g.cena;
  document.getElementById('mTimestamp').innerText = g.accredit_timestamp || '-';
  renderCodesList('mCoatsList', g.codice_coat || [], i, 'coat');
  renderCodesList('mLuggsList', g.codice_lugg || [], i, 'lugg');
  document.getElementById('extraCodes').innerText = ( (g.codice_coat||[]).slice(3).concat((g.codice_lugg||[]).slice(3)).join(', ') ) || '-';
  document.getElementById('extraNote').innerText = g.note || '-';
  document.getElementById('extraPanel').style.display = 'none';
  modal.show();
}

function renderCodesList(containerId, arr, guestIndex, type){
  const cont = document.getElementById(containerId); cont.innerHTML = '';
  (arr||[]).forEach(code=>{
    const pill = document.createElement('div'); pill.className = 'code-pill me-2 mb-2';
    pill.innerHTML = `<span>${escapeHtml(code)}</span><button data-code="${escapeHtml(code)}" data-idx="${guestIndex}" data-type="${type}" title="Rimuovi" style="border:0;background:transparent;color:#c33">×</button>`;
    cont.appendChild(pill);
  });
  cont.querySelectorAll('button').forEach(b=>{ b.onclick = (ev)=>{ ev.stopPropagation(); const c=b.dataset.code, idx=parseInt(b.dataset.idx), t=b.dataset.type; removeCodeFromGuest(idx,c,t); }; });
}

function removeCodeFromGuest(idx, code, t){ if (!confirm('Rimuovere il codice "'+code+'" da questo ospite?')) return; if (t === 'coat') guests[idx].codice_coat = (guests[idx].codice_coat||[]).filter(x=>x!==code); else guests[idx].codice_lugg = (guests[idx].codice_lugg||[]).filter(x=>x!==code); saveState(); openEditModal(idx); }

document.getElementById('addCoatBtn').addEventListener('click', ()=>{ const idx=parseInt(document.getElementById('editIndex').value); const raw=document.getElementById('mCoatNew').value; if(!raw) return; const codes=splitCodesRaw(raw); guests[idx].codice_coat = Array.from(new Set([...(guests[idx].codice_coat||[]), ...codes])); document.getElementById('mCoatNew').value=''; saveState(); openEditModal(idx); });
document.getElementById('addLuggBtn').addEventListener('click', ()=>{ const idx=parseInt(document.getElementById('editIndex').value); const raw=document.getElementById('mLuggNew').value; if(!raw) return; const codes=splitCodesRaw(raw); guests[idx].codice_lugg = Array.from(new Set([...(guests[idx].codice_lugg||[]), ...codes])); document.getElementById('mLuggNew').value=''; saveState(); openEditModal(idx); });

document.getElementById('btnToggleExtra').addEventListener('click', ()=>{ const p=document.getElementById('extraPanel'); p.style.display = p.style.display==='none'?'block':'none'; });

document.getElementById('editForm').addEventListener('submit',(e)=>{ e.preventDefault(); const i=parseInt(document.getElementById('editIndex').value); if (isNaN(i)) return; guests[i].code_client = document.getElementById('mCode').value.trim(); guests[i].cognome = document.getElementById('mCognome').value.trim(); guests[i].nome = document.getElementById('mNome').value.trim(); guests[i].email = document.getElementById('mEmail').value.trim(); guests[i].hotel = document.getElementById('mHotel').value.trim(); guests[i].notti = document.getElementById('mNotti').value.trim(); guests[i].assigned_pallet = document.getElementById('mPallet').value.trim(); guests[i].spunta = document.getElementById('mSpunta').value.trim(); guests[i].allergies = document.getElementById('mAllergie').value.trim(); guests[i].note = document.getElementById('mNote').value.trim(); guests[i].cena = document.getElementById('mCena').checked; saveState(); bootstrap.Modal.getInstance(document.getElementById('editModal')).hide(); });

document.getElementById('deleteRow').addEventListener('click', ()=>{ const i=parseInt(document.getElementById('editIndex').value); if (isNaN(i)) return; if (!confirm('Eliminare questo ospite?')) return; guests.splice(i,1); saveState(); bootstrap.Modal.getInstance(document.getElementById('editModal')).hide(); });

document.getElementById('btnShowAdd').addEventListener('click', ()=>{ const modalEl=document.getElementById('editModal'); const modal=new bootstrap.Modal(modalEl); document.getElementById('editIndex').value = guests.length; document.getElementById('mCode').value=''; document.getElementById('mCognome').value=''; document.getElementById('mNome').value=''; document.getElementById('mEmail').value=''; document.getElementById('mHotel').value=''; document.getElementById('mNotti').value=''; document.getElementById('mPallet').value=''; document.getElementById('mSpunta').value=''; document.getElementById('mAllergie').value=''; document.getElementById('mNote').value=''; document.getElementById('mCoatsList').innerHTML=''; document.getElementById('mLuggsList').innerHTML=''; document.getElementById('mTimestamp').innerText='-'; modal.show(); });

document.getElementById('btnClear').addEventListener('click', ()=>{ if (!confirm('Cancellare i dati locali (localStorage)?')) return; localStorage.removeItem(STORAGE_KEY); guests=[]; loadState(); });

document.getElementById('btnExportJSON').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(guests,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='accrediti_export_v3.json'; a.click(); URL.revokeObjectURL(url); });

document.getElementById('btnExportCSV').addEventListener('click', ()=>{ const headers=['code_client','cognome','nome','email','hotel','notti','codice_coat','codice_lugg','assigned_pallet','cena','spunta','allergies','note','accreditato','accredit_timestamp','createdAt']; const rows=[headers.join(',')].concat(guests.map(g=>{ const row=headers.map(h=>{ let val=g[h]; if (Array.isArray(val)) val=val.join(';'); if (val===undefined||val===null) val=''; return '"'+(String(val).replace(/"/g,'""'))+'"'; }); return row.join(','); })); const blob=new Blob([rows.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='accrediti_export_v3.csv'; a.click(); URL.revokeObjectURL(url); });

document.getElementById('selectAll').addEventListener('change',(e)=>{ const checked=e.target.checked; document.querySelectorAll('.row-select').forEach(cb=>cb.checked=checked); });

document.getElementById('btnAccreditaSel').addEventListener('click', ()=>{ bulkAccredit(); });

document.getElementById('fileInput').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if (!f) return;
  const name = f.name.toLowerCase();
  const reader = new FileReader();
  reader.onload = (ev) => {
    const data = ev.target.result;
    try {
      if (name.endsWith('.csv') || name.endsWith('.txt')){
        const txt = (typeof data === 'string') ? data : new TextDecoder('utf-8').decode(data);
        parseCSV(txt);
      } else {
        const wb = XLSX.read(data, {type:'array'});
        const first = wb.SheetNames[0];
        const sheet = wb.Sheets[first];
        const json = XLSX.utils.sheet_to_json(sheet, {defval:''});
        importRows(json);
      }
    } catch(err){
      alert('Errore import: ' + err.message);
      console.error(err);
    }
  };
  if (name.endsWith('.csv') || name.endsWith('.txt')){
    reader.readAsText(f, 'utf-8');
  } else {
    reader.readAsArrayBuffer(f);
  }
});

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  if (!lines.length) return;
  const sep = (lines[0].includes(';') && !lines[0].includes(',')) ? ';' : ',';
  const headers = lines[0].split(sep).map(h=>h.trim());
  const rows = lines.slice(1).map(l=>{
    const cols = l.split(sep);
    const obj = {};
    headers.forEach((h, idx)=> obj[h.trim()] = (cols[idx]||'').trim());
    return obj;
  });
  importRows(rows);
}

// label generation
function gatherSelectedIndices(){ const selected=Array.from(document.querySelectorAll('.row-select')).filter(cb=>cb.checked).map(cb=>parseInt(cb.dataset.index)); return selected.length ? selected : guests.map((g,idx)=>idx); }
function buildLabelEntriesForType(indices, type){
  const entries = [];
  const sorted = indices.slice().sort((a,b)=>{ const A=(guests[a].cognome||'').toLowerCase(), B=(guests[b].cognome||'').toLowerCase(); if (A < B) return -1; if (A > B) return 1; return (guests[a].nome||'').toLowerCase().localeCompare((guests[b].nome||'').toLowerCase()); });
  sorted.forEach(i=>{ const g = guests[i]; const codes = (type==='coat' ? (g.codice_coat||[]) : (g.codice_lugg||[])); (codes||[]).forEach(code=>{ entries.push({code, displayName: ((g.cognome||'') + (g.nome?(' '+g.nome):'')).trim()}); }); });
  return entries;
}

function openLabelsWindow(entries){
  const perPage = 24;
  const style = `<style>
    @page { size: A4; margin: 2.5mm 0 2.5mm 0; }
    body{font-family: Arial, Helvetica, sans-serif; margin:0; padding:2.5mm; background:white; color:#000}
    .page{display:grid; grid-template-columns: repeat(3, 1fr); grid-auto-rows: 35mm; gap:0; width:100%;}
    .label{box-sizing:border-box; padding:4mm; display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center; border:0;}
    .code{font-weight:800; font-size:22px; letter-spacing:1px; color: var(--ottanio);}
    .name{font-size:10px; margin-top:6px}
  </style>`;
  let html = '<html><head>'+style+'</head><body>';
  for (let p=0; p<Math.ceil(entries.length/perPage); p++){
    html += '<div class="page">';
    const pageEntries = entries.slice(p*perPage, (p+1)*perPage);
    pageEntries.forEach(en=>{ html += `<div class="label"><div class="code">${en.code}</div><div class="name">${en.displayName}</div></div>`; });
    const rem = perPage - pageEntries.length;
    for (let k=0;k<rem;k++) html += `<div class="label"></div>`;
    html += '</div>';
    if (p < Math.ceil(entries.length/perPage)-1) html += '<div style="page-break-after:always;"></div>';
  }
  html += '</body></html>';
  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
}

// print single-column for M110 roll
function openM110Window(entries){
  // single column page: each label 70x36mm stacked vertically
  const style = `<style>
    @page { margin: 0; size: 80mm auto; }
    body{font-family: Arial, Helvetica, sans-serif; margin:0; padding:4mm; background:white; color:#000}
    .label{width:70mm; height:36mm; display:flex; flex-direction:column; align-items:center; justify-content:center; border-bottom:1px dashed #ddd; box-sizing:border-box}
    .code{font-weight:800; font-size:28px; letter-spacing:1px}
    .name{font-size:12px; margin-top:6px}
  </style>`;
  let html = '<html><head>'+style+'</head><body>';
  entries.forEach(en=>{
    html += `<div class="label"><div class="code">${en.code}</div><div class="name">${en.displayName}</div></div>`;
  });
  html += '</body></html>';
  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
}

// event handlers for label buttons
document.getElementById('btnGenerateCoatLabels').addEventListener('click', ()=>{ const entries=buildLabelEntriesForType(gatherSelectedIndices(),'coat'); if(!entries.length) return alert('Nessun codice coat trovato per le righe selezionate.'); openLabelsWindow(entries); });
document.getElementById('btnGenerateLuggLabels').addEventListener('click', ()=>{ const entries=buildLabelEntriesForType(gatherSelectedIndices(),'lugg'); if(!entries.length) return alert('Nessun codice luggage trovato per le righe selezionate.'); openLabelsWindow(entries); });
document.getElementById('btnPrintM110').addEventListener('click', ()=>{ const entries = buildLabelEntriesForType(gatherSelectedIndices(),'coat').concat(buildLabelEntriesForType(gatherSelectedIndices(),'lugg')); if(!entries.length) return alert('Nessun codice trovato per stampa M110.'); openM110Window(entries); });

// generate missing
document.getElementById('btnGenerateMissing').addEventListener('click', ()=>{ if(!confirm('Generare codici mancanti per tutti gli ospiti?')) return; generateMissingCodes(); });

// search
document.getElementById('searchInput').addEventListener('input',(e)=>{ renderTable(e.target.value); });

// paste import
document.addEventListener('paste',(ev)=>{ const text=(ev.clipboardData||window.clipboardData).getData('text'); if (text && text.includes('\n') && (text.includes(',')||text.includes(';'))){ if (confirm('Rilevato testo incollato: importare come CSV?')) parseCSV(text); } });

// bulkAccredit function already defined earlier
function bulkAccredit(){ bulkAccredit = bulkAccreditInternal; bulkAccredit(); } // placeholder

function bulkAccreditInternal(){
  const selected = Array.from(document.querySelectorAll('.row-select')).filter(cb=>cb.checked).map(cb=>parseInt(cb.dataset.index,10));
  if (!selected.length){ alert('Seleziona almeno una riga.'); return; }
  const missing = selected.filter(i=> !guests[i].spunta || String(guests[i].spunta).trim()==='');
  if (missing.length){
    alert('Alcuni selezionati non hanno la spunta obbligatoria. Apri i dettagli e imposta la spunta (o togli la selezione).'); return;
  }
  const now = new Date().toISOString();
  selected.forEach(i=>{ guests[i].accreditato = true; guests[i].accredit_timestamp = now; });
  saveState();
}

// initial load
loadState();

// small shim: re-bind accredita buttons after each render
const observer = new MutationObserver(()=>{ document.querySelectorAll('.btn-accredita').forEach(b=>{ if(!b.dataset.bound){ b.dataset.bound='1'; b.addEventListener('click', (ev)=>{ ev.stopPropagation(); const idx=parseInt(b.dataset.index,10); accreditaIndex(idx); }); } }); });
observer.observe(document.getElementById('tableBody'), { childList:true, subtree:true });

</script>
</body>
</html>
