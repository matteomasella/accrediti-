<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Piattaforma Accrediti — Lactalis / All4U (v4.1)</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
  :root{
    --ottanio: #004D54;
    --magenta: #DB4F61;
    --verde: #54C4A6;
    --glass-bg: rgba(255,255,255,0.06);
  }
  html,body{height:100%;background:
    linear-gradient(180deg, rgba(11,34,36,1) 0%, rgba(4,77,84,1) 50% , rgba(11,34,36,1) 100% ); color:#fff; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
  .app-shell{min-height:100vh; padding:28px; display:flex; flex-direction:column; gap:18px;}
  .glass {
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border: 1px solid rgba(255,255,255,0.06);
    box-shadow: 0 6px 20px rgba(0,0,0,0.45);
    backdrop-filter: blur(8px);
    border-radius: 12px;
    padding: 14px;
  }
  h2 small {color: rgba(255,255,255,0.7); font-weight:400}
  .small-muted {color: rgba(255,255,255,0.7); font-size:0.9rem}
  .btn-ottanio {background:var(--ottanio); color: #fff; border:0}
  .btn-ottanio-outline {color:var(--ottanio); border:1px solid rgba(255,255,255,0.12); background:transparent}
  .table-fixed {max-height: 56vh; overflow:auto; display:block;}
  table thead {position: sticky; top: 0; background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); z-index:5}
  .tag {display:inline-block;padding:3px 6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);margin:2px;font-size:0.78rem;background:rgba(255,255,255,0.02)}
  .code-pill{background:transparent;padding:4px;border-radius:6px;border:1px dashed rgba(255,255,255,0.04);display:inline-flex;gap:8px;align-items:center}
  .accepted {background: linear-gradient(90deg, rgba(84,196,166,0.08), rgba(84,196,166,0.03)) !important}
  .controls .btn{margin-right:6px}
  .muted {color: rgba(255,255,255,0.6)}
  .allergy-checkbox {transform:scale(1.1); margin-right:6px}
  .open-card-btn {padding:0.25rem 0.5rem}
  @media print {
    @page { size: A4; margin: 2.5mm 0 2.5mm 0; }
    body{background:transparent;color:#000}
  }
  .metric-small {font-size:0.9rem;color:rgba(255,255,255,0.78)}
  .metric-big {font-weight:700;font-size:1.6rem}
</style>
</head>
<body>
<div class="app-shell container">
  <div class="glass">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2>Accrediti — Lactalis / All4U <small>v4.1 — fix</small></h2>
        <div class="small-muted">Importa CSV/XLSX — colonne supportate: email, cognome, nome, hotel, notti, codeCoat, codeLuggage, dinner, spunta, allergies</div>
      </div>
      <div class="text-end">
        <div class="small-muted">Palette: Ottanio / Magenta</div>
      </div>
    </div>

    <hr class="my-2">

    <div class="row mb-2 controls">
      <div class="col-md-4 mb-2">
        <input id="fileInput" type="file" class="form-control form-control-sm" accept=".csv,.xlsx,.xls,.ods,.json">
      </div>
      <div class="col-md-4 mb-2">
        <input id="searchInput" type="search" class="form-control form-control-sm" placeholder="Cerca per cognome, nome, codice...">
      </div>
      <div class="col-md-4 text-end">
        <button id="btnGenerateMissing" class="btn btn-ottanio btn-sm">Genera codici mancanti</button>
        <button id="btnGenLuggSelected" class="btn btn-outline-success btn-sm">Genera codice bagaglio (selez.)</button>
        <button id="btnGenerateCoatLabels" class="btn btn-success btn-sm">Etichette Cappotto (A4)</button>
        <button id="btnGenerateLuggLabels" class="btn btn-success btn-sm">Etichette Bagaglio (A4)</button>
      </div>
    </div>

    <div class="mb-2 d-flex gap-2">
      <button id="btnOpenCardGlob" class="btn btn-outline-light btn-sm">Apri scheda (selez.)</button>
      <button id="btnAccreditaSel" class="btn btn-ottanio btn-sm">Accredita selezionati</button>
      <button id="btnExportCSV" class="btn btn-outline-light btn-sm">Esporta CSV</button>
      <button id="btnClear" class="btn btn-danger btn-sm">Reset locale</button>
    </div>

    <div class="row g-2 mb-3">
      <div class="col-md-2"><div class="glass p-2"><div class="metric-small">Totale</div><div class="metric-big" id="totalCount">0</div></div></div>
      <div class="col-md-2"><div class="glass p-2"><div class="metric-small">Accreditati</div><div class="metric-big" id="acceptedCount">0</div></div></div>
      <div class="col-md-2"><div class="glass p-2"><div class="metric-small">In attesa</div><div class="metric-big" id="pendingCount">0</div></div></div>
      <div class="col-md-3"><div class="glass p-2"><div class="metric-small">Tempo medio accreditamento</div><div class="metric-big" id="avgTime">--</div></div></div>
      <div class="col-md-3"><div class="glass p-2"><div class="metric-small">Media accreditamenti / 10 min</div><div class="metric-big" id="avgPer10min">--</div><div class="small-muted" id="avgPer10minUpdated">aggiornato: --</div></div></div>
    </div>

    <div id="tableWrap" class="table-responsive table-fixed glass border p-0">
      <table id="guestsTable" class="table table-sm table-borderless m-0 text-white align-middle">
        <thead>
          <tr>
            <th style="width:36px"><input id="selectAll" type="checkbox"></th>
            <th>Cognome</th>
            <th>Nome</th>
            <th>Codice</th>
            <th>Coat</th>
            <th>Lugg</th>
            <th>Allergie</th>
            <th>Cena (spunta)</th>
            <th>Allergie (spunta)</th>
            <th>Apri scheda</th>
            <th>Accredita</th>
            <th>Stato</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

  </div>
</div>

<!-- Modal add/edit -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form id="editForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Scheda Ospite</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editIndex">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-2"><label class="form-label">Cognome</label><input id="mCognome" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Nome</label><input id="mNome" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Email (visibile solo qui)</label><input id="mEmail" class="form-control" readonly></div>

            <div class="mb-2"><label class="form-label">Codici Cappotto</label>
              <div id="mCoatsList" class="codes-list mb-2"></div>
              <div class="input-group"><input id="mCoatNew" class="form-control" placeholder="Aggiungi codice coat"><button id="addCoatBtn" class="btn btn-outline-secondary" type="button">Aggiungi</button></div>
            </div>

            <div class="mb-2"><label class="form-label">Codici Bagaglio</label>
              <div id="mLuggsList" class="codes-list mb-2"></div>
              <div class="input-group"><input id="mLuggNew" class="form-control" placeholder="Aggiungi codice luggage"><button id="addLuggBtn" class="btn btn-outline-secondary" type="button">Aggiungi</button></div>
            </div>

            <div class="form-check mt-2"><input id="mCena" type="checkbox" class="form-check-input"><label class="form-check-label">Partecipa alla cena</label></div>
          </div>

          <div class="col-md-6">
            <div class="mb-2"><label class="form-label">Hotel</label><input id="mHotel" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Notti</label><input id="mNotti" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Spunta (obbligatoria)</label><input id="mSpunta" class="form-control" placeholder="es: Nessuna / Si / Specifica"></div>

            <div class="mb-2"><label class="form-label">Allergie</label><input id="mAllergie" class="form-control" placeholder="Lascia 'Nessuna' se non ci sono"></div>
            <div class="form-check mt-2"><input id="mAllergieConfirm" type="checkbox" class="form-check-input"><label class="form-check-label">Spunta allergie (confermato)</label></div>

            <div class="small-muted mt-3">Timestamp accreditamento: <span id="mTimestamp">-</span></div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" id="deleteRow" class="btn btn-outline-danger">Elimina</button>
        <button type="submit" class="btn btn-primary">Salva</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
      </div>
    </form>
  </div>
</div>

<script>
/* v4.1 - fixes:
 - colonna Cena con spunta
 - delegation per apri scheda / accredita
 - parse import ignora 'nan' / 'null' / '-' come valori validi
 - bottone Etichette Bagaglio
 - genera codice bagaglio selezionati (alfabetico)
*/

let guests = [];
const STORAGE_KEY = 'accrediti_guests_v4_1';
const COUNTERS_KEY = 'accrediti_counters_v4_1';
let codesMap = {}; // optional map if you want to merge codes by email before import

// ---------- helpers ----------
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(guests)); renderTable(); updateMetrics(); saveCounters(); }
function loadState(){ const s=localStorage.getItem(STORAGE_KEY); guests = s ? JSON.parse(s) : []; initCountersFromData(); renderTable(); updateMetrics(); }
function saveCounters(){ localStorage.setItem(COUNTERS_KEY, JSON.stringify(window._ac_counters||{coatCounter:1,luggCounter:1})); }
function getCounters(){ const s = localStorage.getItem(COUNTERS_KEY); try{ return s?JSON.parse(s):{coatCounter:1,luggCounter:1}; }catch(e){return {coatCounter:1,luggCounter:1};} }
function ensureCounters(){ if(!window._ac_counters) window._ac_counters = getCounters(); }

function isMissingVal(v){
  if (v===undefined || v===null) return true;
  const s = String(v).trim().toLowerCase();
  return s==='' || s==='nan' || s==='null' || s==='-' || s==='n/a' || s==='na';
}

function splitCodesRaw(str){
  if (isMissingVal(str)) return [];
  str = String(str).trim();
  if (!str) return [];
  return Array.from(new Set(str.split(/[;,|\n\r\t]+/).map(t=>t.trim()).filter(t=>t!=='' && t.toLowerCase()!=='nan' && t.toLowerCase()!=='null')));
}

function pad(n){ return String(n).padStart(3,'0'); }

// ---------- import / normalize ----------
function normalizeRowForImport(r){
  const get = (keys) => { for (const k of keys) if (r[k] !== undefined && r[k] !== null && String(r[k]).trim()!=='') return String(r[k]).trim(); return ''; };
  const obj = {};
  obj.code_client = get(['Name','name','name_client','code_client']) || '';
  obj.cognome = get(['cognome','Cognome','Surname','surname']) || '';
  obj.nome = get(['nome','Nome','givenName']) || '';
  obj.email = get(['email','Email','MAIL']) || '';
  obj.hotel = get(['hotel','Hotel']) || '';
  obj.notti = get(['notti','Notti']) || '';
  const coatRaw = get(['codeCoat','code_coat','coat_code','coat','codice_coat']);
  const luggRaw = get(['codeLuggage','code_lugg','luggage_code','lugg','codice_lugg']);
  obj.codice_coat = splitCodesRaw(coatRaw);
  obj.codice_lugg = splitCodesRaw(luggRaw);
  const dinnerRaw = get(['dinner','cena','Cena']);
  obj.cena = (dinnerRaw && String(dinnerRaw).toLowerCase().startsWith('s')) ? true : false;
  obj.spunta = get(['Spunta','spunta']) || '';
  obj.allergies = get(['allergies','ALLERGIE','allergie']) || '';
  obj.note = get(['note','Note']) || '';
  obj.accreditato = false;
  obj.accredit_timestamp = '';
  obj.createdAt = new Date().toISOString();
  return obj;
}

function findGuestByCodeClient(code){ if(!code) return -1; return guests.findIndex(g => String(g.code_client||'').toLowerCase() === String(code||'').toLowerCase()); }
function findGuestByEmail(email){ if(!email) return -1; const e = (email||'').toString().trim().toLowerCase(); return guests.findIndex(g => (g.email||'').toString().trim().toLowerCase() === e); }

function mergeGuest(existingIdx, incoming){
  const g = guests[existingIdx];
  g.codice_coat = Array.from(new Set([...(g.codice_coat||[]), ...(incoming.codice_coat||[])]));
  g.codice_lugg = Array.from(new Set([...(g.codice_lugg||[]), ...(incoming.codice_lugg||[])]));
  ['email','hotel','notti','spunta','note'].forEach(k=>{ if (incoming[k]) g[k] = incoming[k]; });
  if (!g.cognome && incoming.cognome) g.cognome = incoming.cognome;
  if (!g.nome && incoming.nome) g.nome = incoming.nome;
  if (incoming.cena) g.cena = true;
  if (incoming.allergies) g.allergies = incoming.allergies;
  saveState();
}

function addNewGuest(obj){
  const g = {
    code_client: obj.code_client || ((obj.cognome||'') + (obj.nome ? ('-'+obj.nome) : '')).trim(),
    cognome: obj.cognome || '',
    nome: obj.nome || '',
    email: obj.email || '',
    hotel: obj.hotel || '',
    notti: obj.notti || '',
    codice_coat: obj.codice_coat || [],
    codice_lugg: obj.codice_lugg || [],
    cena: !!obj.cena,
    spunta: obj.spunta || '',
    spunta_allergie: false,
    allergies: obj.allergies || '',
    note: obj.note || '',
    accreditato: false,
    accredit_timestamp: '',
    createdAt: obj.createdAt || new Date().toISOString()
  };
  guests.push(g);
  saveState();
}

function importRows(rows){
  const imported = rows.map(r=>normalizeRowForImport(r));
  let countNew = 0, countMerged = 0;
  imported.forEach(incoming=>{
    if (!incoming.code_client || incoming.code_client.trim()==='') incoming.code_client = (incoming.cognome + (incoming.nome?('-'+incoming.nome):'')).trim();
    let idx = findGuestByCodeClient(incoming.code_client);
    if (idx === -1 && incoming.email) idx = findGuestByEmail(incoming.email);
    if (idx >= 0){ mergeGuest(idx, incoming); countMerged++; } else { addNewGuest(incoming); countNew++; }
  });
  alert(`Import completato: ${countNew} nuovi, ${countMerged} aggiornati (merge codici).`);
}

// ---------- CSV parser ----------
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  if (!lines.length) return [];
  const first = lines[0];
  const sep = (first.includes(';') && !first.includes(',')) ? ';' : (first.includes(',') ? ',' : ',');
  const headers = lines[0].split(sep).map(h=>h.trim());
  const rows = lines.slice(1).map(l=>{
    const cols = l.split(sep);
    const obj = {};
    headers.forEach((h, idx)=> obj[h.trim()] = (cols[idx]||'').trim());
    return obj;
  });
  return rows;
}

// ---------- file input ----------
document.getElementById('fileInput').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if (!f) return;
  const name = f.name.toLowerCase();
  const reader = new FileReader();
  reader.onload = (ev) => {
    const data = ev.target.result;
    try {
      if (name.endsWith('.csv') || name.endsWith('.txt')){
        const rows = parseCSV((typeof data === 'string') ? data : new TextDecoder('utf-8').decode(data));
        importRows(rows);
      } else {
        const wb = XLSX.read(data, {type:'array'});
        const first = wb.SheetNames[0];
        const sheet = wb.Sheets[first];
        const json = XLSX.utils.sheet_to_json(sheet, {defval:''});
        importRows(json);
      }
    } catch(err){
      alert('Errore import: ' + err.message);
      console.error(err);
    }
  };
  if (name.endsWith('.csv') || name.endsWith('.txt')) reader.readAsText(f, 'utf-8'); else reader.readAsArrayBuffer(f);
});

// ---------- render ----------
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }

function renderTable(filter=''){
  const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
  const f = filter.trim().toLowerCase();
  const sorted = guests.map((g, idx) => ({g, idx})).sort((A,B)=>{
    const a = (A.g.cognome||'').toLowerCase(), b = (B.g.cognome||'').toLowerCase();
    if (a < b) return -1; if (a > b) return 1; return (A.g.nome||'').toLowerCase().localeCompare((B.g.nome||'').toLowerCase());
  });
  sorted.forEach(item => {
    const g = item.g; const idx = item.idx;
    if (f) { const combined = ((g.cognome||'')+' '+(g.nome||'')+' '+(g.code_client||'')+' '+(g.codice_coat||[]).join(' ')+' '+(g.codice_lugg||[]).join(' ')).toLowerCase(); if (!combined.includes(f)) return; }
    const tr = document.createElement('tr');
    if (g.accreditato) tr.classList.add('accepted');
    const cenaCheck = `<input class="cena-checkbox" data-index="${idx}" type="checkbox" ${g.cena ? 'checked' : ''}>`;
    const allergyCheck = `<input class="allergy-checkbox" data-index="${idx}" type="checkbox" ${g.spunta_allergie ? 'checked' : ''}>`;
    tr.innerHTML = `
      <td><input class="row-select" type="checkbox" data-index="${idx}"></td>
      <td>${escapeHtml(g.cognome||'')}</td>
      <td>${escapeHtml(g.nome||'')}</td>
      <td>${escapeHtml(g.code_client||'')}</td>
      <td>${(g.codice_coat||[]).slice(0,3).map(c=>'<span class="tag">'+escapeHtml(c)+'</span>').join(' ')}</td>
      <td>${(g.codice_lugg||[]).slice(0,3).map(c=>'<span class="tag">'+escapeHtml(c)+'</span>').join(' ')}</td>
      <td>${escapeHtml(g.allergies||'')}</td>
      <td class="text-center">${cenaCheck}</td>
      <td class="text-center">${allergyCheck}</td>
      <td class="text-center"><button class="btn btn-sm btn-outline-light open-card-btn" data-index="${idx}">Apri</button></td>
      <td><button class="btn btn-sm btn-success btn-accredita" data-index="${idx}">Accredita</button></td>
      <td class="small-muted">${g.accreditato?('Accreditato @ '+g.accredit_timestamp):'Pending'}</td>
    `;
    tbody.appendChild(tr);
  });
  // attach event delegation for table (robust)
}

// delegate clicks in table (single handler)
document.getElementById('tableBody').addEventListener('click', function(ev){
  const btn = ev.target.closest('button');
  if (btn){
    const idx = parseInt(btn.dataset.index,10);
    if (btn.classList.contains('btn-accredita')){ ev.stopPropagation(); accreditaIndex(idx); return; }
    if (btn.classList.contains('open-card-btn')){ ev.stopPropagation(); openEditModal(idx); return; }
  }
  // checkbox clicks
  const chk = ev.target.closest('input[type="checkbox"]');
  if (chk && chk.classList.contains('cena-checkbox')){
    const i = parseInt(chk.dataset.index,10);
    guests[i].cena = !!chk.checked; saveState(); return;
  }
  if (chk && chk.classList.contains('allergy-checkbox')){
    const i = parseInt(chk.dataset.index,10);
    guests[i].spunta_allergie = !!chk.checked; saveState(); return;
  }
});

// ---------- metrics ----------
function updateMetrics(){
  const total = guests.length; const accepted = guests.filter(g => g.accreditato).length; const pending = total - accepted;
  document.getElementById('totalCount').innerText = total;
  document.getElementById('acceptedCount').innerText = accepted;
  document.getElementById('pendingCount').innerText = pending;
  // avg time actual (minutes+seconds)
  const durations = guests.filter(g=>g.accreditato && g.accredit_timestamp && g.createdAt).map(g=>{ const d1=new Date(g.createdAt); const d2=new Date(g.accredit_timestamp); return (d2-d1)/1000; }).filter(n=>!isNaN(n) && n>0);
  let avgText = '--';
  if (durations.length){
    const avgSec = durations.reduce((a,b)=>a+b,0)/durations.length;
    const m = Math.floor(avgSec/60);
    const s = Math.round(avgSec%60);
    avgText = `${m}m ${s}s`;
  }
  document.getElementById('avgTime').innerText = avgText;
  computeAvgPer10Min();
  document.title = `Accrediti — ${accepted}/${total}`;
}

// compute avg per 10min
function computeAvgPer10Min(){
  const accs = guests.filter(g=>g.accreditato && g.accredit_timestamp).map(g=>new Date(g.accredit_timestamp).getTime()).sort((a,b)=>a-b);
  if(!accs.length){ document.getElementById('avgPer10min').innerText='--'; document.getElementById('avgPer10minUpdated').innerText='aggiornato: --'; return; }
  const first = accs[0], last = accs[accs.length-1];
  const spanMinutes = Math.max(10, Math.ceil((last-first)/(1000*60)));
  const intervals = Math.ceil(spanMinutes / 10);
  const avgPer10 = (accs.length / intervals);
  document.getElementById('avgPer10min').innerText = avgPer10.toFixed(2);
  document.getElementById('avgPer10minUpdated').innerText = 'aggiornato: ' + (new Date()).toLocaleTimeString();
}
setInterval(()=>{ computeAvgPer10Min(); }, 600000); // every 10 minutes

// ---------- accreditation ----------
function accreditaIndex(i){
  const g = guests[i];
  if (!g.spunta || String(g.spunta).trim() === ''){
    alert('Impossibile accreditare: la spunta (campo obbligatorio) non è impostata per questo ospite. Apri la scheda e inserisci "Nessuna" o la specifica.');
    return;
  }
  if (g.allergies && g.allergies.trim() !== '' && !g.spunta_allergie){
    alert('Impossibile accreditare: questo ospite ha allergie registrate. Conferma la spunta allergie nella scheda o nella tabella.');
    return;
  }
  const now = new Date().toISOString();
  guests[i].accreditato = true; guests[i].accredit_timestamp = now; saveState();
  renderTable(document.getElementById('searchInput').value);
}

// bulk accredit
document.getElementById('btnAccreditaSel').addEventListener('click', ()=>{
  const selected = Array.from(document.querySelectorAll('.row-select')).filter(cb=>cb.checked).map(cb=>parseInt(cb.dataset.index,10));
  if (!selected.length){ alert('Seleziona almeno una riga.'); return; }
  const missing = selected.filter(i=> !guests[i].spunta || String(guests[i].spunta).trim()==='');
  if (missing.length){ alert('Alcuni selezionati non hanno la spunta obbligatoria. Apri i dettagli e imposta la spunta (o togli la selezione).'); return; }
  const lackingAllergyConfirm = selected.filter(i => guests[i].allergies && guests[i].allergies.trim() !== '' && !guests[i].spunta_allergie);
  if (lackingAllergyConfirm.length){ alert('Alcuni selezionati hanno allergie senza conferma (checkbox). Apri le schede e conferma le allergie.'); return; }
  const now = new Date().toISOString();
  selected.forEach(i=>{ guests[i].accreditato = true; guests[i].accredit_timestamp = now; });
  saveState();
});

// ---------- modal edit ----------
function openEditModal(i){
  const modalEl = document.getElementById('editModal'); const modal = new bootstrap.Modal(modalEl);
  const g = guests[i];
  document.getElementById('editIndex').value = i;
  document.getElementById('mCognome').value = g.cognome || '';
  document.getElementById('mNome').value = g.nome || '';
  document.getElementById('mEmail').value = g.email || '';
  document.getElementById('mHotel').value = g.hotel || '';
  document.getElementById('mNotti').value = g.notti || '';
  document.getElementById('mSpunta').value = g.spunta || '';
  document.getElementById('mAllergie').value = g.allergies || '';
  document.getElementById('mAllergieConfirm').checked = !!g.spunta_allergie;
  document.getElementById('mCena').checked = !!g.cena;
  document.getElementById('mTimestamp').innerText = g.accredit_timestamp || '-';
  renderCodesList('mCoatsList', g.codice_coat || [], i, 'coat');
  renderCodesList('mLuggsList', g.codice_lugg || [], i, 'lugg');
  modal.show();
}
function renderCodesList(containerId, arr, guestIndex, type){
  const cont = document.getElementById(containerId); cont.innerHTML = '';
  (arr||[]).forEach(code=>{
    const pill = document.createElement('div'); pill.className = 'code-pill me-2 mb-2';
    pill.innerHTML = `<span>${escapeHtml(code)}</span><button data-code="${escapeHtml(code)}" data-idx="${guestIndex}" data-type="${type}" title="Rimuovi" style="border:0;background:transparent;color:#c33">×</button>`;
    cont.appendChild(pill);
  });
  cont.querySelectorAll('button').forEach(b=>{ b.onclick = (ev)=>{ ev.stopPropagation(); const c=b.dataset.code, idx=parseInt(b.dataset.idx), t=b.dataset.type; removeCodeFromGuest(idx,c,t); }; });
}
function removeCodeFromGuest(idx, code, t){ if (!confirm('Rimuovere il codice "'+code+'" da questo ospite?')) return; if (t === 'coat') guests[idx].codice_coat = (guests[idx].codice_coat||[]).filter(x=>x!==code); else guests[idx].codice_lugg = (guests[idx].codice_lugg||[]).filter(x=>x!==code); saveState(); openEditModal(idx); }

document.getElementById('addCoatBtn').addEventListener('click', ()=>{ const idx=parseInt(document.getElementById('editIndex').value); const raw=document.getElementById('mCoatNew').value; if(!raw) return; const codes=splitCodesRaw(raw); guests[idx].codice_coat = Array.from(new Set([...(guests[idx].codice_coat||[]), ...codes])); document.getElementById('mCoatNew').value=''; saveState(); openEditModal(idx); });
document.getElementById('addLuggBtn').addEventListener('click', ()=>{ const idx=parseInt(document.getElementById('editIndex').value); const raw=document.getElementById('mLuggNew').value; if(!raw) return; const codes=splitCodesRaw(raw); guests[idx].codice_lugg = Array.from(new Set([...(guests[idx].codice_lugg||[]), ...codes])); document.getElementById('mLuggNew').value=''; saveState(); openEditModal(idx); });

document.getElementById('editForm').addEventListener('submit',(e)=>{ e.preventDefault(); const i=parseInt(document.getElementById('editIndex').value); if (isNaN(i)) return; guests[i].cognome = document.getElementById('mCognome').value.trim(); guests[i].nome = document.getElementById('mNome').value.trim(); guests[i].email = document.getElementById('mEmail').value.trim(); guests[i].hotel = document.getElementById('mHotel').value.trim(); guests[i].notti = document.getElementById('mNotti').value.trim(); guests[i].spunta = document.getElementById('mSpunta').value.trim(); guests[i].allergies = document.getElementById('mAllergie').value.trim(); guests[i].spunta_allergie = !!document.getElementById('mAllergieConfirm').checked; guests[i].cena = !!document.getElementById('mCena').checked; saveState(); bootstrap.Modal.getInstance(document.getElementById('editModal')).hide(); });

document.getElementById('deleteRow').addEventListener('click', ()=>{ const i=parseInt(document.getElementById('editIndex').value); if (isNaN(i)) return; if (!confirm('Eliminare questo ospite?')) return; guests.splice(i,1); saveState(); bootstrap.Modal.getInstance(document.getElementById('editModal')).hide(); });

// ---------- exports & controls ----------
document.getElementById('btnClear').addEventListener('click', ()=>{ if (!confirm('Cancellare i dati locali (localStorage)?')) return; localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(COUNTERS_KEY); guests=[]; loadState(); });
document.getElementById('btnExportCSV').addEventListener('click', ()=>{ const headers=['code_client','cognome','nome','email','hotel','notti','codice_coat','codice_lugg','cena','spunta','spunta_allergie','allergies','note','accreditato','accredit_timestamp','createdAt']; const rows=[headers.join(',')].concat(guests.map(g=>{ const row=headers.map(h=>{ let val=g[h]; if (Array.isArray(val)) val=val.join(';'); if (val===undefined||val===null) val=''; return '"'+(String(val).replace(/"/g,'""'))+'"'; }); return row.join(','); })); const blob=new Blob([rows.join('\n')],{type:'text/csv'}); saveAs(blob,'accrediti_export_v4_1.csv'); });

document.getElementById('selectAll').addEventListener('change',(e)=>{ const checked=e.target.checked; document.querySelectorAll('.row-select').forEach(cb=>cb.checked=checked); });

document.getElementById('searchInput').addEventListener('input',(e)=>{ renderTable(e.target.value); });

// ---------- counters / generate missing ----------
function initCountersFromData(){
  let counters = getCounters();
  guests.forEach(g=>{
    (g.codice_coat||[]).forEach(c=>{ const m = c.match(/(\d{3})$/); if(m){ const v=parseInt(m[1],10); if(v>=counters.coatCounter) counters.coatCounter = v+1; }});
    (g.codice_lugg||[]).forEach(c=>{ const m = c.match(/(\d{3})$/); if(m){ const v=parseInt(m[1],10); if(v>=counters.luggCounter) counters.luggCounter = v+1; }});
  });
  window._ac_counters = counters;
  saveCounters();
}
function generateMissingCodes(){
  ensureCounters();
  const counters = window._ac_counters;
  guests.forEach(g=>{
    (g.codice_coat||[]).forEach(c=>{ const m=c.match(/(\d{3})$/); if(m){ const v=parseInt(m[1],10); if(v>=counters.coatCounter) counters.coatCounter = v+1; }});
    (g.codice_lugg||[]).forEach(c=>{ const m=c.match(/(\d{3})$/); if(m){ const v=parseInt(m[1],10); if(v>=counters.luggCounter) counters.luggCounter = v+1; }});
  });
  let created = 0;
  guests.forEach(g=>{
    if(!g.codice_coat || !g.codice_coat.length){
      const base = (g.cognome||'X').toUpperCase().replace(/\s+/g,'').slice(0,10);
      const code = `C-${base}-${pad(counters.coatCounter++)}`;
      g.codice_coat = g.codice_coat || []; g.codice_coat.push(code); created++;
    }
    if(!g.codice_lugg || !g.codice_lugg.length){
      const base = (g.cognome||'X').toUpperCase().replace(/\s+/g,'').slice(0,10);
      const code = `L-${base}-${pad(counters.luggCounter++)}`;
      g.codice_lugg = g.codice_lugg || []; g.codice_lugg.push(code); created++;
    }
  });
  window._ac_counters = counters; saveState();
  alert('Generati ' + created + ' codici mancanti.');
}
document.getElementById('btnGenerateMissing').addEventListener('click', ()=>{ if(!confirm('Generare codici mancanti per tutti gli ospiti?')) return; generateMissingCodes(); });

// ---------- generate luggage code for selected (alphabetical) ----------
document.getElementById('btnGenLuggSelected').addEventListener('click', ()=>{
  ensureCounters();
  const counters = window._ac_counters;
  const selected = Array.from(document.querySelectorAll('.row-select')).filter(cb=>cb.checked).map(cb=>parseInt(cb.dataset.index,10));
  if (!selected.length) return alert('Seleziona almeno un ospite.');
  const sorted = selected.slice().sort((a,b)=>{
    const A = (guests[a].cognome||'').toLowerCase(), B = (guests[b].cognome||'').toLowerCase();
    if (A < B) return -1; if (A > B) return 1;
    return (guests[a].nome||'').toLowerCase().localeCompare((guests[b].nome||'').toLowerCase());
  });
  // ensure counters updated
  guests.forEach(g=> (g.codice_lugg||[]).forEach(c=>{ const m=c.match(/(\d{3})$/); if(m){ const v=parseInt(m[1],10); if(v>=counters.luggCounter) counters.luggCounter = v+1; } }));
  let created = 0;
  sorted.forEach(i=>{
    const g = guests[i];
    if(!g.codice_lugg || !g.codice_lugg.length){
      const base = (g.cognome||'X').toUpperCase().replace(/\s+/g,'').slice(0,10);
      const code = `L-${base}-${pad(counters.luggCounter++)}`;
      g.codice_lugg = g.codice_lugg || []; g.codice_lugg.push(code); created++;
    }
  });
  window._ac_counters = counters;
  if(created === 0) return alert('Nessun ospite selezionato necessita codice luggage (tutti hanno già uno).');
  saveState();
  alert('Generati ' + created + ' codici luggage per gli ospiti selezionati (ordine alfabetico).');
});

// ---------- labels ----------
function gatherSelectedIndices(){ const selected=Array.from(document.querySelectorAll('.row-select')).filter(cb=>cb.checked).map(cb=>parseInt(cb.dataset.index,10)); return selected.length ? selected : guests.map((g,idx)=>idx); }
function buildLabelEntriesForType(indices, type){
  const entries = [];
  const sorted = indices.slice().sort((a,b)=>{ const A=(guests[a].cognome||'').toLowerCase(), B=(guests[b].cognome||'').toLowerCase(); if (A < B) return -1; if (A > B) return 1; return (guests[a].nome||'').toLowerCase().localeCompare((guests[b].nome||'').toLowerCase()); });
  sorted.forEach(i=>{ const g = guests[i]; const codes = (type==='coat' ? (g.codice_coat||[]) : (g.codice_lugg||[])); (codes||[]).forEach(code=>{ if (code && String(code).trim()!=='') entries.push({code, displayName: ((g.cognome||'') + (g.nome?(' '+g.nome):'')).trim()}); }); });
  return entries;
}
function openLabelsWindow(entries){
  const perPage = 24;
  const style = `<style>@page{size:A4;margin:2.5mm 0 2.5mm 0}body{font-family:Arial;margin:0;padding:2.5mm;color:#000}.page{display:grid;grid-template-columns:repeat(3,1fr);grid-auto-rows:36mm;width:210mm}.label{padding:2.5mm;display:flex;flex-direction:column;justify-content:center;align-items:center}.code{font-weight:900;font-size:28px}.name{font-size:10px;margin-top:6px}</style>`;
  let html = '<html><head>'+style+'</head><body>';
  for (let p=0; p<Math.ceil(entries.length/perPage); p++){
    html += '<div class="page">';
    const pageEntries = entries.slice(p*perPage, (p+1)*perPage);
    pageEntries.forEach(en=>{ html += `<div class="label"><div class="code">${en.code}</div><div class="name">${en.displayName}</div></div>`; });
    const rem = perPage - pageEntries.length;
    for (let k=0;k<rem;k++) html += `<div class="label"></div>`;
    html += '</div>';
    if (p < Math.ceil(entries.length/perPage)-1) html += '<div style="page-break-after:always;"></div>';
  }
  html += '</body></html>';
  const w = window.open('','_blank'); w.document.write(html); w.document.close();
}

document.getElementById('btnGenerateCoatLabels').addEventListener('click', ()=>{ const entries=buildLabelEntriesForType(gatherSelectedIndices(),'coat'); if(!entries.length) return alert('Nessun codice coat trovato.'); openLabelsWindow(entries); });
document.getElementById('btnGenerateLuggLabels').addEventListener('click', ()=>{ const entries=buildLabelEntriesForType(gatherSelectedIndices(),'lugg'); if(!entries.length) return alert('Nessun codice bagaglio trovato (le celle vuote o "nan" non vengono importate).'); openLabelsWindow(entries); });

// convenience: open card for first selected
document.getElementById('btnOpenCardGlob').addEventListener('click', ()=>{
  const selected = Array.from(document.querySelectorAll('.row-select')).filter(cb=>cb.checked).map(cb=>parseInt(cb.dataset.index,10));
  if(!selected.length) return alert('Seleziona almeno una riga e poi clicca "Apri scheda".');
  openEditModal(selected[0]);
});

// initial load
loadState();
renderTable();
updateMetrics();

</script>
</body>
</html>
